## 起源

系统管理员负责将现成软件组件部署在生产环境中，应对系统中产生的各种需要人工干预的事件以及来自业务部门的变更需求，他们通常和研发工程师分属两个团队：

-   Dev：开发部；
-   Ops：运维部。

这种 Dev/Ops 团队分离会带来一些无法避免的问题：

1.  直接成本：运维团队大部分依赖人工处理事件，团队的大小基本与系统负载成线性相关；
2.  间接成本：研发团队和运维团队的背景、技术能力各异，对产品的可靠性理解以及某项操作的危险性评估也不同，这些累计起来逐渐会演变成内部沟通问题，甚至上升到部门之间的信任与尊重层面。

分歧核心是**研发团队关注如何快速构建、发布新功能，运维团队关注如何避免发生故障**，绝大部分故障都是由于部署项变更导致的（新功能、新配置、甚至是 bugfix），这两个目标本质上是互相矛盾的。

基于这种分歧，一种可能的极端情况则是运维团队会指定研发团队在上线前经过繁冗复杂的检查流程，而研发团队则会宣称他们会转为功能开关调整、增量更新、补丁化，利用各种名词绕过这些流程。

Google 采用了 SRE 模型来尝试避免这种矛盾的结果，SRE 本质就是**让软件工程师来设计一个新型运维团队，通过软件工程上的一些自动化思想来取代部分重复、效率低下的人工操作**。

## SRE 方法论

SRE 团队要承担以下几类职责：

-   可用性改进；
-   延迟优化；
-   性能优化；
-   效率优化；
-   变更管理；
-   监控；
-   紧急事项处理；
-   容量规划与管理。

而 SRE 的核心方法论有以下几个：

### **确保长期关注研发工作**

Google 将 SRE 团队的运维工作限制在 50% 内，SRE 团队应该将剩余时间花在研发项目上

### **在保障服务 SLO 的前提下最大化迭代速度**

SRE 使用错误预算模型来评估迭代速度和产品稳定程度之间的平衡，错误预算起源于这个理念：**任何产品都不是，也不应该做到 100% 可靠**。对最终用户来说，99.999% 和 100% 没有实质区别，从服务器到最终用户之间有很多中间系统，全链路综合起来的可靠性远远低于 99.999%。

错误预算的定义即为 1-可靠性目标，如果可靠性是 4 个 9，那么错误预算就是 0.0.1%，研发可以在这个范围内最大化新功能的上线速度同时保障服务稳定性质量。

### 监控系统

一个需要人工阅读邮件和分析警报来决定目前是否需要采取某种行动的系统本质上就是错误的。监控系统不应该依赖人来分析警报信息，而是由系统自动分析，仅当用户需要某种操作时，才需要通知用户。

一个监控系统应该只有三类输出：

紧急警报：收到警报的用户需要立即执行某种操作，解决某种已发生或避免即将发生的问题；

工单：意味着用户应该执行单并非立即需要执行某种操作；

日志：以备调试和事后分析。

### 应急事件处理

可靠性是 MTTF（平均失败时间）和 MTTR（平均恢复时间）的函数，评价一个系统恢复到正常情况最有效的指标就是 MTTR。

一个可以自动恢复的系统即使有更多的故障发生也比事事需要人工干预的系统可靠性更高，但不可避免需要人工介入时，通过事先预案并将最佳方案记录在运维手册上通常可以使 MTTR 降低 3 倍以上。长久看来一个手持”运维宝典“经过多次演习的 on-call 工程师才是正确之路。

### 变更管理

大概 70% 的生产事故是由某种部署变更而触发，变更管理的最佳实践是使用自动化来完成以下几个项目：

-   采用渐进式发布机制；
-   迅速而准确地检测到问题发生；
-   当出现问题时，安全迅速地回退改动。

这三点在国内部分大厂也有相应的落地机制，比如对应蚂蚁的三板斧：可灰度、可观测、可回滚。

### 需求预测和容量规划

保障一个业务有足够容量和冗余度去服务预测中的未来需求：

-   有一个准确的自然增长需求预测模型；
-   有一个准确的非自然增长的需求来源统计；
-   有周期性压力测试，以便准确地将系统原始资源信息与业务容量对应起来。

一些团队会为服务预留一倍资源以防止流量突增翻倍，就是出于这种思想。

### 资源部署

资源部署是变更管理与容量规划的结合物，必须能够迅速地完成并且保证正确性。增加现有容量通常需要启动一个新的实例甚至是集群，这需要大幅度修改现有的集群配置（配置文件、负载均衡、网络等），因此新资源的部署与配置是一个比较危险的操作。

### 效率与性能

一个业务总体资源的使用情况由以下三个因素驱动：

-   用户需求（流量）；
-   可用容量；
-   软件的资源使用率。

通过改进资源使用率，可以非常有效地降低系统的总成本。